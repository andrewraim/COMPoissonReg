---
title: "COMPoissonReg Demo"
author: "Andrew Raim"
date: "November 26, 2016"
output: pdf_document
---

## COM Poisson Regression

Generate some data.

```{r}
library(COMPoissonReg, quietly = TRUE)
set.seed(1235)

n <- 400
x <- runif(n, 1, 4)
X <- model.matrix(~ x)
beta.true <- c(1, 0.5)
lambda.true <- exp(X %*% beta.true)
nu.true <- 0.75

# compoisson::rcom doesn't seem to support vectorization
y <- numeric(n)
for (i in 1:n) {
	y[i] <- rcom(1, lambda = lambda.true[i], nu = nu.true)
}
dat <- data.frame(y = y, x = x)
```

Fit the model.

```{r}
cmp.out <- cmp(y ~ x, data = dat)
print(cmp.out)
```

Plot the randomized quantile residuals.

```{r, fig.width=4, fig.height=4}
y.hat <- predict(cmp.out)
res <- resid(cmp.out, type = "quantile")
qqnorm(res); qqline(res, lty = 2, col = "red", lwd = 2)
plot(y.hat, res)
```

Run the test for equidispersion.

```{r, fig.width=4, fig.height=4}
chisq(cmp.out)
pval(cmp.out)
```

## Zero-Inflated COM Poisson Regression

```{r, echo=FALSE}
rm(list = ls())
```


Generate some data.

```{r}
library(COMPoissonReg, quietly = TRUE)
set.seed(1235)

n <- 400
x <- runif(n, 1, 4)
X <- model.matrix(~ x)
S <- matrix(1, n, 1)
W <- model.matrix(~ x)
beta.true <- c(1, 2)
gamma.true <- 1
zeta.true <- c(0.05, -1)
lambda.true <- exp(X %*% beta.true)
nu.true <- exp(S %*% gamma.true)
p.true <- plogis(W %*% zeta.true)

y <- r.zi.compoisson(n, lambda = lambda.true, nu = nu.true, p = p.true)
dat <- data.frame(y = y, x = x)
```

Fit the model. The package notices that we specify only an intercept for $\nu$, and also displays an estimate for $\nu$ directly by using the appropriate transformation.

```{r}
zicmp.out <- zicmp(y ~ x, formula.nu = ~ 1, formula.p = ~ x, data = dat)
print(zicmp.out)
```

Plot the randomized quantile residuals.

```{r, fig.width=4, fig.height=4}
y.hat <- predict(zicmp.out)
res <- resid(zicmp.out, type = "quantile")
qqnorm(res); qqline(res, lty = 2, col = "red", lwd = 2)
plot(y.hat, res)
```

Run the test for equidispersion.

```{r, fig.width=4, fig.height=4}
chisq(zicmp.out)
pval(zicmp.out)
```
